# Chapter 11. 단위 테스트의 실제

**좋은 단위 테스트가 가져야 하는 주요 특징**

- 코드의 문제를 정확하게 감지한다.
- 구현 세부 정보에 구애받지 않는다.
- 실패는 잘 설명된다.
- 테스트 코드가 이해하기 쉽다.
- 테스트를 쉽고 빠르게 실행할 수 있다.

--- 

## 기능뿐만 아니라 동작을 시험하라

단순히 눈에 보이는 대로 함수 이름을 테스트 목록에 넣기보다는 함수가 수행하는 모든 동작으로 목록을 채우는 것이 좋다.

### 함수당 하나의 테스트 케이스만 있으면 적절하지 않을 때가 많다

### 해결책 : 각 동작을 테스트하는 데 집중하라

함수롸 동작 사이에 일대일로 연결이 안 되는 경우가 많다.

함수 자체를 테스트하는 데만 집중하면, 정작 실제로 신경 써야 할 중요한 동작을 검증하지 않는 테스트 케이스를 작성하기가 매우 쉽다.

테스트 코드의 양이 실제 코드의 양보다 많지 않다면, 모든 동작이 제대로 테스트되고 있지 않음을 나타내는 경고 표시일 수 있다.

**모든 동작이 테스트되었는지 거듭 확인하라**

코드를 검토하는 과정

- 삭제해도 여전히 컴파일되거나 테스트가 통과하는 코드 라인이 있는가?
- if문 (또는 이와 동등한 기능의 문장)의 참 거짓 논리를 반대로 해도 테스트가 통과하는가?
- 논리 연산자나 산술 연산자를 다른 것으로 대체해도 테스트가 통과하는가?
- 상숫값이나 하드 코딩된 값을 변경해도 테스트가 통과하는가?

**오류 시나리오를 잊지 말라**

---

## 테스트만을 위해 퍼블릭으로 만들지 말라

### 프라이빗 함수를 테스트하는 것은 바람직하지 않을 때가 많다

### 해결책 : 퍼블릭 API를 통해 테스트하라

### 해결책 : 코드를 더 작은 단위로 분할하라

클래스가 너무 많은 작업을 할 경우 Public API만으로 모든 것을 테스트하기 어려울 수 있다.

큰 클래스를 더 작은 클래스로 나누면 코드를 더 쉽게 테스트할 수 있다.

코드를 테스트하기 위해 프라이빗 함수를 퍼블릭으로 만든다면, 이것은 실제로 신경 써야 하는 생동을 테스트하지 않는다는 경고 신호로 받아들여야 한다.

---

## 한 번에 하나의 동작만 테스트하라

### 여러 동작을 한꺼번에 테스트하면 테스트가 제대로 안 될 수 있다.

하나의 테스트 케이스로 모든 행동을 테스트하면 테스트 코드는 이해하기 어려워진다.

한 번에 여러 동작을 테스트하면 테스트가 실패하더라도 실패에 대한 설명이 자세히 제공되지 않을 수 있다.

### 해결책 : 각 동작은 자체 테스트 케이스에서 테스트하라

잘 명명된 테스트 케이스를 사용하여 각 동작을 개별적으로 테스트하는 것!

한 번에 하나의 동작을 테스트하면 테스트가 통과되지 못한 경우 메시지는 무엇이 문제인지 잘 설명한다.

### 매개변수를 사용한 테스트

테스트 케이스 함수를 한 번 작성한 다음 매개변수에 다른 값을 설정해 여러 시나리오를 테스트할 수 있다.

---

## 공유 설정을 적절하게 사용하라

공유 설정
- BeforeAll : 테스트 케이스가 실행되기 전에 단 한 번 실행
- BeforeEach : 각 테스트 케이스가 실행되기 전에 매번 실행

공유 해체
- AfterAll : 모든 테스트 케이스가 실행된 후 한 번 실행
- AfterEach : 각 테스트 케이스가 실행된 후에 매번 실행

- 상태 공유
  - 설정 코드가 BeforeAll 블록에 추가되면 모든 테스트 케이스 전에 한 번 실행된다.
  - 설정된 모든 상태가 모든 테스트 케이스 간에 공유된다.
  - 이러한 유형의 설정은 설정을 실행하는 데 시간이 오래 걸리거나, 비용이 많이 드는 경우에 유용할 수 있다. (ex: 테스트 서버를 시작하거나 데이터베이스의 테스트 인스턴스를 만드는 경우)
  - 그러나 설정된 상태가 가변적인 경우에는 한 테스트 케이스의 실행 결과가 다른 테스트 케이스에 악영향을 미칠 수 있는 위험이 있다.

- 설정 공유
  - 설정 코드가 BeforeEach 블록에 추가되면 각 테스트 케이스가 실행되기 전에 실행된다.
  - 테스트 케이스는 이 코드에 의한 모든 설정을 공유한다.
  - 설정 코드가 특정 값을 포함하거나 특정 방식으로 의존성을 설정하는 경우 각 테스트 케이스 전에 실행되므로 테스트 케이스 간에 공유되는 상태는 없다.


### 상태 공유는 문제가 될 수 있다

테스트 케이스 간에 상태를 공유하고 이 상태가 가변적이면 한 테스트 케이스가 수행하는 모든 조치는 다른 테스트 케이스의 결과에 영향을 미치지 않아야 한다는 규칙을 위반하기 쉽다.

서로 다른 테스트 케이스 간에 가변적인 상태를 공유하면 문제가 발생하기 매우 쉽다.

가능하면 상태를 공유하지 않는 것이 최선이다.

하지만 상태 공유가 꼭 필요하다면 한 테스트 케이스에 의해 변경된 상태가 다른 테스트 케이스에 영향을 미치지 않도록 조심해야 한다.


### 해결책: 상태를 공유하지 않거나 초기화하라

문제를 해결하기 위한 가장 분명한 방법은 애초에 가변적인 상태를 공유하지 않는 것!

피할 수 없다면 각 테스트 케이스 간에 상태를 초기화해야 한다.

> 전역 상태
> 
> 테스트 대상 코드가 전역 상태를 유지한다면 테스트 케이스마다 이 전역 상태를 확실하게 초기화해야한다.
> 전역 상태가 코드의 테스트 용이성에 영향을 미친다는 점도 전역 상태를 사용하지 말아야 하는 이유 중 하나다.


### 설정 공유는 문제가 될 수 있다.

공유 설정의 잘못된 변경으로 문제가 발생할 수 있다.

설정을 공유하는 것은 코드의 반복을 피하는 데는 유용하지만 일반적으로 테스트 케이스에 중요한 값이나 상태는 공유하지 않는 것이 최선이다!


### 해결책: 중요한 설정은 테스트 케이스 내에서 정의하라

테스트 케이스의 결과가 설정값에 직접 영향을 받는 경우 해당 테스트 케이스 내에서 설정하는 것이 가장 좋다.


### 설정 공유가 적절한 경우

필요하면서도 테스트 케이스의 결과에 직접적인 영향을 미치지 않는 설정같은 경우에는 설정 공유를 통해 불필요한 코드 반복을 피할 수 있고 테스트는 좀 더 뚜렷한 목적을 갖고 이해하기 쉬워진다.

---

## 적절한 어서션 확인자를 사용하라

어서션 확인자는 보통 테스트 통과 여부를 최종적으로 결정하기 위한 테스트 케이스 내의 코드다.

### 부적합한 확인자는 테스트 실패를 잘 성명하지 못할 수 있다.

- 과도하게 제한된 테스트 어서션

- 실패 이유를 제대로 설명해주지 않는 테스트 어서션

### 해결책: 적절한 확인자를 사용하라


---

## 테스트 용이성을 위해 의존성 주입을 사용하라

### 하드 코딩된 의존성은 테스트를 불가능하게 할 수 있다.

### 해결책: 의존성 주입을 사용하라

테스트 용이성은 모듈화와 밀접한 관련이 있다.

서로 다른 코드가 느슨하게 결합하고 재설정이 가능하면, 테스트는 훨씬 더 쉬워지는 경향을 띤다.

의존성 주입은 코드를 좀더 모듈화하기 위한 효과적인 기술이며, 따라서 코드의 테스트 용이성을 높이기 위한 효과적인 기술이기도 하다.

---

- 통합 테스트 (integration test) 

한 시스템은 일반적으로 여러 구성 요소, 모듈, 하위 시스템으로 구성된다. 이러한 구성 요소와 하위 시스템을 서로 연결하는 프로세스를 통합이라고 한다.

통합 테스트는 이러한 통합이 제대로 작동하는지 확인하기 위한 테스트다.


- 종단 간 테스트 (end-to-end-test)

이 테스트는 처음부터 끝까지 전체 소프트웨어 시스템을 통과하는 여정(또는 작업 흐름)을 테스트한다.

테스트하려는 소프트웨어가 온라인 쇼핑몰이라면, E2E 테스트의 예로는 웹 브라우저를 자동으로 구동하고 사용자가 구매를 완료하는 과정까지 거치면서 구매가 잘 이루어지는지 확인하는 것이다.

---

## 요약

- 각 함수를 테스트하는 것에 집중하다 보면 테스트가 충분히 되지 못하기 쉽다. 보통은 모든 중요한 행동을 파악하고 각각의 테스트 케이스를 작성하는 것이 더 효과적이다.
- 결과적으로 중요한 동작을 테스트해야 한다. 프라이빗 함수를 테스트하는 것은 거의 대부분 결과적으로 중요한 사항을 테스트하는 것이 아니다.
- 한 번에 한 가지씩만 테스트하면 테스트 실패의 이유를 더 잘 알 수 있고 테스트 코드를 이해하기가 더 쉽다.
- 테스트 설정 공유는 양날의 검이 될 수 있다. 코드 반복이나 비용이 큰 설정을 피할 수 있지만 부적잘하게 사용할 경우 효과적이지 못하거나 신뢰할 수 없는 결과를 초래할 수 있다.
- 의존성 주입을 사용하면 코드의 테스트 용이성이 상당히 향상될 수 있다.
- 단위 테스트는 개발자들이 가장 자주 다루는 테스트 수준이지만 이것만이 유일한 테스트는 아니다. 높은 품질의 소프트웨어를 작성하고 유지하려면 여러 가지 테스트 기술을 함께 사용해야 할 때가 많다.

